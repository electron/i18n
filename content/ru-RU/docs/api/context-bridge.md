# contextBridge

> Создает безопасный, двунаправленный, синхронный мост через изолированные контексты

Процесс: [Графический](../glossary.md#renderer-process)

Пример предоставления API-интерфейса средству визуализации из изолированного сценария предварительной загрузки приведен ниже:

```javascript
// Предварительная загрузка (Isolated World/Изолированный Мир)
const { contextBridge, ipcRenderer } = require('electron')

contextBridge.exposeInMainWorld(
  'electron',
  {
    doThing: () => ipcRenderer.send('do-a-thing')
  }
)
```

```javascript
// Рендер (Main World/Основной Мир)

window.electron.doThing()
```

## Глоссарий

### Main World / Основной Мир

"Главный мир" - это контекст JavaScript, в котором работает ваш основной код рендерера. По умолчанию веб- , которую вы загружаете в рендерер, выполняет код в этом мире.

### Isolated World / Изолированный Мир

Когда `contextIsolation` включен в вашем `webPreferences`, `preload` скрипты работают в "Изолированном мире".  Вы можете прочитать больше об изоляции контекста и о том, что она влияет [безопасности](../tutorial/security.md#3-enable-context-isolation-for-remote-content) документов.

## Методы

Модуль `contextBridge` имеет следующие методы:

### `contextBridge.exposeInMainWorld(apiKey, api)` _Experimental_

* `apiKey` String - Ключ для вставки API в `window`.  API будет доступен в `window[apiKey]`.
* `api` - Ваш API, более подробная информация о том, что этот API может быть и как он работает доступна ниже.

## Использование

### API

В `api` , предоставленном [`exposeInMainWorld`](#contextbridgeexposeinmainworldapikey-api-experimental) , должен быть объект `Function`, `String`, `Number`, `Array`, `Boolean`, или объект ключами которого являются строки и значения `Function`, `String`, `Number`, `Array`, `Boolean`или другой вложенный объект, который отвечает тем же условиям.

Значения `Function` передаются в другой контекст, а все остальные значения **копируются** и **заморожены**. Любые данные / примитивы, отправленные , когда API становятся неизменными, а обновления по обе стороны моста не приводят к обновлению с другой стороны.

Пример сложного API приведен ниже:

```javascript
const { contextBridge } = require('electron')

contextBridge.exposeInMainWorld(
  'electron',
  {
    doThing: () => ipcRenderer.send('do-a-thing'),
    myPromises: [Promise.resolve(), Promise.reject(new Error('whoops'))],
    anAsyncFunction: async () => 123,
    data: {
      myFlags: ['a', 'b', 'c'],
      bootTime: 1234
    },
    nestedAPI: {
      evenDeeper: {
        youCanDoThisAsMuchAsYouWant: {
          fn: () => ({
            returnData: 123
          })
        }
      }
    }
  }
)
```

### Функции API

Значения `Function`, которые вы связываете через `contextBridge`, передаются через Electron, чтобы гарантировать, что контексты остаются изолированными.  Это приводит к некоторым ключевым ограничениям, которые мы описали ниже.

#### Параметр / Ошибка / Поддержка возвращаемого типа

Поскольку параметры, ошибки и значения возврата **скопированы** когда они отправляются по мосту, есть только определенные типы, которые могут быть использованы. На высоком уровне, если тип, который вы хотите использовать, может быть сериализован и deserialized в тот же объект, он будет работать.  Ниже для полноты изложения приводится таблица поддержки типов:

| Тип                                                                                                            | Сложность | Поддержка параметров | Возврат значения поддержки | Ограничения                                                                                                                                                                                                                                            |
| -------------------------------------------------------------------------------------------------------------- | --------- | -------------------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `String`                                                                                                       | Простой   | ✅                    | ✅                          | Нет                                                                                                                                                                                                                                                    |
| `Number`                                                                                                       | Простой   | ✅                    | ✅                          | Нет                                                                                                                                                                                                                                                    |
| `Boolean`                                                                                                      | Простой   | ✅                    | ✅                          | Нет                                                                                                                                                                                                                                                    |
| `Object`                                                                                                       | Сложный   | ✅                    | ✅                          | Ключи должны поддерживаться с использованием только типов "Просто" в этой таблице.  Значения должны поддерживаться в этой таблице.  Модификации прототипа отбрасываются.  Отправка пользовательских классов будет копировать значения, но не прототип. |
| `Array`                                                                                                        | Сложный   | ✅                    | ✅                          | Те же ограничения, что и в типе `Object`                                                                                                                                                                                                               |
| `Error`                                                                                                        | Сложный   | ✅                    | ✅                          | Ошибки, которые выбрасываются также копируются, это может привести к тому, что сообщение и трассировка стека ошибки немного изменятся из-за того, что они будут выброшены в другом контексте                                                           |
| `Promise`                                                                                                      | Сложный   | ✅                    | ✅                          | Обещания только прокси, если они являются значение возврата или точный параметр.  Обещания, вложенные в массивы или объекты, будут удалены.                                                                                                            |
| `Function`                                                                                                     | Сложный   | ✅                    | ✅                          | Модификации прототипа отбрасываются.  Отправка классов или конструкторов не будет работать.                                                                                                                                                            |
| [Cloneable Types](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm) | Простой   | ✅                    | ✅                          | Смотрите связанный документ по клонируемым типам                                                                                                                                                                                                       |
| `Symbol`                                                                                                       | Нет       | ❌                    | ❌                          | Символы не могут быть скопированы в разных контекстах, поэтому они отбрасываются                                                                                                                                                                       |

Если тип, который вас волнует, не находится в таблице выше, он, вероятно, не поддерживается.
