# Updating an Appveyor Azure Image

Electron CI на Windows использует AppVeyor, который в свою очередь использует изображения Azure VM для запуска.  Иногда эти VM-изображения необходимо обновлять из-за изменений в требованиях к хрому.  Для обновления вам понадобится [PowerShell](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-6) [модуля Azure PowerShell](https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0&viewFallbackFrom=azurermps-6.13.0).

Иногда нам нужно обновить эти изображения из-за изменений в хроме или других различных изменений требования сборки.

Пример применения:
    * Нам нужна `VS15.9` , и мы `VS15.7` установлены; это потребует от нас обновления изображения Azure.

1. Определите изображение, которое вы хотите изменить.
    * В [appveyor.yml](https://github.com/electron/electron/blob/master/appveyor.yml), изображение идентифицируется свойством *изображения*.
        * Используемые имена соответствуют *"изображениям",* для облака сборки, например, [libcc-20](https://windows-ci.electronjs.org/build-clouds/8).
    * Найдите изображение, которое вы хотите изменить в облаке сборки, и обратите внимание на **VHD Blob Path** для этого изображения, которое является значением для этого соответствующего ключа.
        * Вам понадобится этот путь URI, чтобы скопировать в новое изображение.
    * Вам также понадобится имя учетной записи хранения, которое помечено в AppVeyor как **имя учетной записи**

2. Получить ключ учетной записи хранения Azure
    * Войдите в Azure с помощью учетных данных, хранящихся в LastPass (в рамках Azure Enterprise), а затем найдите учетную запись хранения, соответствующую имени, найденному в AppVeyor.
        * Пример, для `appveyorlibccbuilds` **учетной записи disk** , которую вы `appveyorlibccbuilds` в списке учетных записей хранения данных и учетных записей домашнего < хранения данных
            * Нажмите на него и ищите `Access Keys`, а затем вы можете использовать любой из ключей, присутствующих в списке.

3. Получить полное изображение виртуальной машины URI от Azure
    * Перейдите на домашние < хранения данных < `$ACCT_NAME` < Blobs < Images
        * В следующем списке ищите имя пути VHD, которое вы получили от Appveyor, а затем нажмите на него.
            * Скопировать весь URL из верхней части последующего окна.

4. Копировать изображение с помощью [Master Image PowerShell](https://github.com/appveyor/ci/blob/master/scripts/enterprise/copy-master-image-azure.ps1).
    * Очень важно скопировать VM, потому что если вы вращаете VM против изображения, что изображение не может в то же время быть использованы AppVeyor.
    * Для запуска этого скрипта используйте имя учетной записи хранения данных, ключ и URI, полученные из Azure.
        * См. Шаг 3 для URI & по запросу, нажмите введите использовать ту же учетную запись хранения, что и пункт назначения.
        * Используйте имя контейнера назначения по умолчанию `(images)`
        * Кроме того, при наименовании копии используйте имя, указывая, что будет содержать новое изображение (если это изменилось) и штамп даты.
            * Бывший. `libcc-20core-vs2017-15.9-2019-04-15.vhd`
    * Перейдите в Azure и получите URI для вновь созданного изображения, описанного на предыдущем этапе

5. Закрути новый VM с помощью [создать мастер VM от VHD PowerShell](https://github.com/appveyor/ci/blob/master/scripts/enterprise/create_master_vm_from_vhd.ps1).
    * Из PowerShell выполните `ps1` файл с `./create_master_vm_from_vhd.ps1`
    * Вам понадобится информация о учетных данных, доступная в определении облака сборки AppVeyor.
        * Это включает в себя:
            * Идентификатор клиента
            * Секрет клиента
            * Идентификатор арендатора
            * Идентификатор подписки
            * Ресурсная группа
            * Виртуальная сеть
    * Вам также нужно будет указать
        * Master VM имя - просто уникальное имя для идентификации временного VM
        * Мастер VM размер - использование `Standard_F32s_v2`
        * Мастер VHD URI - использование URI, полученное в конце предыдущего шага
        * Использование местоположения `East US`

6. Вернитесь в Azure и найдите только что созданный вами VM в < виртуальных < `$YOUR_NEW_VM`
    * Вы можете скачать файл RDP (Remote Desktop) для доступа к VM.

7. Используя удаленный рабочий стол Майкрософт, `Connect` кнопку для подключения к VM.
    * Учетные данные для входа в VM находятся в LastPass под `AppVeyor Enterprise master VM` данных.

8. Измените VM по мере необходимости.

9. Выключите VM, а затем удалите его в Azure.

10. Добавьте новое изображение в настройки Облака Appveyor или измените существующее изображение, чтобы указать на новый VHD.
