# Патчи в Electron

Электрон построен на двух крупных проектах вверх по течению: Хром и узел.js. Каждый из этих проектов имеет несколько своих собственных зависимостей, тоже. Мы стараемся изо всех сил использовать эти зависимости именно так, как они есть, но иногда мы не можем достичь наших целей без исправления этих зависимостей вверх по течению, чтобы соответствовать нашим случаям использования.

## Обоснование патча

Каждый патч в Electron является бременем обслуживания. При изменении кода вверх по течению патчи могут ломаться, иногда даже без конфликта патчей или ошибки компиляции. Это постоянные усилия, чтобы сохранить наш патч настройки в курсе и эффективным. Таким образом, мы стремимся сохранить наш патч рассчитывать на минимум. С этой целью каждый патч должен описать свою причину существования в своем сообщении о совершении. Эта причина должна быть одной из следующих:

1. Патч является временным, и предназначен для (или был) совершен вверх по течению или иным образом в конечном итоге удалены. Включите ссылку на обзор PR или кода вверх по течению, если таковые имеются, или процедуру проверки того, нужен ли патч позже.
2. Патч позволяет компилировать код в среде Electron, но не может быть вверх по течению, потому что это электрон-специфический (например, исправление ссылок на `Profile`). Включите рассуждения о том, почему изменение не может быть реализовано без патча (например, путем подклассификации или копирования кода).
3. Патч вносит электрон-специфические изменения в функциональности, которые принципиально несовместимы с вверх по течению.

В целом, все проекты, с которых мы работаем, являются дружественными людьми и часто рады принять рефакторинги, которые позволяют коду, о котором идет речь, быть совместимым как с Electron, так и с проектом вверх по течению. (См., например, [это](https://chromium-review.googlesource.com/c/chromium/src/+/1637040) изменение в Хроме, которое позволило нам удалить патч, который сделал то же самое, или [это изменение](https://github.com/nodejs/node/pull/22110) в узел, который был не-оп для узла, но исправлена ошибка в Electron.) **Мы должны стремиться к изменениям вверх по течению, когда мы можем, и избежать неопределенной жизни патчи**.

## Патч-система

Если вы окажетесь в неблагоприятном положении того, чтобы внести изменения, которые могут быть сделаны только путем исправления вверх по течению проекта, вам нужно знать, как управлять патчи в Electron.

Все патчи для проектов вверх по течению в Electron содержатся в `patches/` каталоге. Каждая поднаправленная `patches/` содержит несколько патч-файлов, а также `.patches` файл, в котором перечислен порядок, в котором патчи должны быть применены. Думайте об этих файлах, как составление серии git коммитов, которые применяются в верхней части проекта вверх по течению после того, как мы проверим его.

```text
патчи
├ config.json   <- это описывает, какой каталог патчетов применяется к тому, что проект
├ " хром
│ ├ ".патчи
│ ├" accelerator.patch.
│ ├ add_contentgpuclient_precreatemessageloop_callback.патч
│ ⋮
├ й узел
│ ├ .»
│ ├ add_openssl_is_boringssl_guard_to_oaep_hash_check.patch
│ ├ build_add_gn_build_files.patch
│ ⋮
⋮
```

Чтобы помочь управлять этими наборами патчей, мы предоставляем два инструмента: `git-import-patches` и `git-export-patches`. `git-import-patches` импортирует набор патч-файлов в репозиторий git, применяя каждый патч в правильном порядке и создавая коммит для каждого из них. `git-export-patches` делает обратное; он экспортирует ряд git коммитов в репозитории в набор файлов в каталоге и сопровождающий его `.patches` файл.

> Примечание стороны: причина, по которой мы используем файл `.patches` для поддержания порядка прикладных патчей, а не для того, чтобы предрасходовать номер типа `001-` к каждому файлу, заключается в том, что он уменьшает конфликты, связанные с заказом патчей. Это предотвращает ситуацию, когда два PRs оба добавить патч в конце серии с той же проемовой и в конечном итоге как получить объединены в результате дубликат идентификатора, а также уменьшает отток, когда патч добавляется или удаляется в середине серии.

### Использование

#### Добавление нового патча

```bash
$ cd src/third_party/electron_node
$ vim some/code/file.cc
$ git commit
$ ../../electron/script/git-export-patches -o ../../electron/patches/node
```

> **ПРИМЕЧАНИЕ**: `git-export-patches` игнорирует любые незавершенные файлы, поэтому вы должны создать коммит, если вы хотите, чтобы ваши изменения были экспортированы. Тема сообщения коммита будет использоваться для получения имени файла патча, а тело сообщения коммита должно включать причину существования патча.

Реэкспорт патчей иногда вызывает shasums в несвязанных патчей изменить. Это, как правило, безвредны и могут быть проигнорированы (но идти вперед и добавить эти изменения в ваш PR, это остановит их от показа для других людей).

#### Редактирование существующего патча

```bash
$ cd src/v8
$ vim some/code/file.cc
$ git log
# Найти коммит патча, который вы хотите редактировать.
$ git commit --fixup [COMMIT_SHA]
$ git rebase --autosquash -i [COMMIT_SHA]^
$ ../electron/script/git-export-patches -o ../electron/patches/v8
```

#### Удаление патча

```bash
$ vim src/electron/patches/node/.patches
- Удалите строку с названием патча, который вы хотите удалить
$ CD src/third_party/electron_node
$ git reset --hard refs/patches/upstream-head
$ . . . . . . . . . /.. /электрон/скрипт/гит-импорт-патчи .. /.. /электрон/патчи/узел
$ .. /.. /электрон/скрипт/git-экспорт-патчи -o .. /.. /электрон/патчи/узел
```

Обратите внимание, `git-import-patches` он будет отмечать коммит, который был `HEAD` , когда он был запущен `refs/patches/upstream-head`. Это позволяет отслеживать, какие коммиты из Electron патчи (те, которые приходят после `refs/patches/upstream-head`) и какие коммиты находятся в вверх по течению (те, `refs/patches/upstream-head`).

#### Разрешение конфликтов

При обновлении зависимости вверх по течению патчи могут не применяться чисто. Часто конфликт может быть решен автоматически с помощью 3-способного слияния. Вы можете поручить `git-import-patches` использовать 3-путь алгоритм слияния, передавая `-3` аргумент:

```bash
$ CD src/third_party/electron_node
- Если приложение патча не удалось на полпути, вы можете сбросить его с:
$ git am --abort
- А затем повторить с 3-путь слияния:
. . . /.. /электрон/скрипт/гит-импорт-патчи -3 .. /.. /электрон/патчи/узел
```

Если `git-import-patches -3` сталкивается с конфликтом слияния, который он не может решить автоматически, он остановится и позволит вам разрешить конфликт вручную. После того как вы разрешили `git add` , вы можете использовать разрешенные файлы и продолжать применять остальные патчи, `git am --continue`.
