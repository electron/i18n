# Windows 10 на руке

Если ваше приложение работает с Electron 6.0.8 или более поздними версиями, вы можете собрать его для Windows 10 на Arm. This considerably improves performance, but requires recompilation of any native modules used in your app. It may also require small fixups to your build and packaging scripts.

## Запуск базового приложения

Если ваше приложение не использует родные модули, то создать версию приложения очень просто.

1. Убедитесь, что каталог `node_modules` вашего приложения пуст.
2. Используя _Command Prompt_, запустите `set npm_config_arch=arm64` перед запуском `npm install`/`yarn install` как обычно.
3. [Если Electron установлен в качестве разработчика зависимостей](quick-start.md#prerequisites), npm загрузит и распакует версию arm64. После этого вы можете распространять ваше приложение нормально.

## Общие соображения

### Индивидуальный код архитектуры

Много Windows-специфический код содержит, если ... еще логика, которая выбирает между архитектурами x64 или x86.

```js
if (process.arch === 'x64') {
  // Do 64-bit thing...
} else {
  // Делайте 32-битную вещь...
}
```

Если вы хотите использовать arm64, такая логика обычно выбирает неправильную архитектуру, так что внимательно проверьте ваше приложение и постройте скрипты на такие условия. В пользовательских скриптах сборки и упаковки вы всегда должны проверить значение `npm_config_arch` в окружении, вместо того, чтобы полагаться на текущую технологическую арку.

### Нативные модули

Если вы используете родные модули, вы должны убедиться, что они компилируются с v142 компилятора MSVC (предоставляется в Visual Studio 2017). Вы также должны проверить, что любой готовый `.dll` или `. ib` файлы, предоставленные или на которые ссылается родной модуль, доступны для Windows на Arm.

### Проверка приложения

Для тестирования приложения используйте Windows на Arm устройстве, работающем под управлением Windows 10 (версии 1903 или выше). Убедитесь, что вы копируете приложение на целевое устройство - песочница Chrome не будет работать корректно при загрузке ресурсов приложения из сети.

## Требования для разработки

### Node.js/node-gyp

[Рекомендуется Node.js v12.9.0 или выше.](https://nodejs.org/en/) При обновлении до новой версии узла нежелательно, вместо этого вы можете [обновить npm копию node-gyp вручную](https://github.com/nodejs/node-gyp/wiki/Updating-npm's-bundled-node-gyp) до версии 5. .2 или более поздней версии, содержащей необходимые изменения для компиляции родных модулей для Arm.

### Visual Studio 2017

Для кросс-компиляции родных модулей необходима Visual Studio 2017 (любая редакция). Вы можете загрузить Visual Studio Community 2017 через программу [Microsoft Visual Studio Dev Essentials](https://visualstudio.microsoft.com/dev-essentials/). После установки, вы можете добавить компоненты, специфичные для Arm, запустив следующие из _командной строки_:

```powershell
vs_installer.exe ^
--add Microsoft.VisualStudio.Workload.NativeDesktop ^
--add Microsoft.VisualStudio.Component.VC.ATLMFC ^
--add Microsoft.VisualStudio.Component.VC.Tools.ARM64 ^
--add Microsoft.VisualStudio.Component.VC.MFC.ARM64 ^
--includeRecommended
```

#### Создание командной строки для кросс-компиляции

Установка `npm_config_arch=arm64` в среде создаёт правильную arm64 `. bj` файлов, но стандартная _команда разработчика для VS 2017_ будет использовать ссылки x64. Чтобы исправить это:

1. Скопируйте команду _x64_x86 для перекрестных инструментов для VS 2017_ (напр. найдя его в меню "Пуск", щелкнув правой кнопкой, выбрав _Open File Location_, скопировав и вставив его в удобное место.
2. Щелкните правой кнопкой мыши на новом ярлыке и выберите _Свойства_.
3. Измените _Цель_ на читание `vcvarsamd64_arm64.bat` в конце вместо `vcvarsamd64_x86.bat`.

Если закончилось успешно, при запуске запрос команды должен напечатать что-то похожее на этого:

```bat
**********************************************************************
** Visual Studio 2017 Developer Command Prompt v15.9.15
** Copyright (c) 2017 Microsoft Corporation
**********************************************************************
[vcvarsall.bat] Environment initialized for: 'x64_arm64'
```

Если вы хотите разработать свое приложение непосредственно на Windows на устройстве Arm, замените `vcvarsx86_arm64. at` в _Target_ для того, чтобы перекрестная компиляция могла произойти с эмуляцией устройства x86.

### Связь с правильным `node.lib`

By default, `node-gyp` unpacks Electron's node headers and downloads the x86 and x64 versions of `node.lib` into `%APPDATA%\..\Local\node-gyp\Cache`, but it does not download the arm64 version ([a fix for this is in development](https://github.com/nodejs/node-gyp/pull/1875).) Чтобы исправить это:

1. Скачайте arm64 `node.lib` с https://electronjs.org/headers/v6.0.9/win-arm64/node.lib
2. Переместить его в `%APPDATA%\..\Local\node-gyp\Cache\6.0.9\arm64\node.lib`

Замена `6.0.9` для используемой версии.

## Кросс-компиляция родных модулей

После завершения всего вышесказанного откройте команду кросс-компиляции и запустите `set npm_config_arch=arm64`. Затем используйте `npm install` , чтобы построить ваш проект как нормальный. Как и в случае с кросс-компиляцией x86 модулей, вам может потребоваться удалить `node_modules` для принудительной перекомпиляции родных модулей, если они были ранее скомпилированы для другой архитектуры.

## Отладка родных модулей

Отладка родных модулей может быть выполнена с Visual Studio 2017 (запущена на вашей машине разработки) и соответствующим [Visual Studio Remote Debugger](https://docs.microsoft.com/en-us/visualstudio/debugger/remote-debugging-cpp?view=vs-2019) , запущенным на целевом устройстве. Для отладки:

1. Запустите приложение `. xe` на целевом устройстве с помощью команды _командной строки_ (передавая `--inspect-brk` , чтобы остановить его до загрузки родных модулей).
2. Запустите Visual Studio 2017 на вашей машине разработки.
3. Подключиться к целевому устройству, выбрав _Отладка > Присоединиться к процессу..._ и введите IP адрес устройства и номер порта, отображаемый утилитой Remote Debugger Visual Studio.
4. Нажмите _Обновите_ и выберите [соответствующий процесс Electron, чтобы прикрепить](../development/debug-instructions-windows.md).
5. Может потребоваться убедиться, что все символы для родных модулей в вашем приложении корректно загружены. Для настройки перейдите на _Отладка > Настройки..._ в Visual Studio 2017, и добавьте папки, содержащие ваши `. db` символов при _Отладке > Символов_.
6. После прикрепления установите соответствующие точки останова и возобновите выполнение JavaScript с помощью [удаленных инструментов для узла](debugging-main-process.md).

## Получить дополнительную помощь

Если вы столкнулись с проблемой с этой документацией, или ваше приложение работает при компиляции для x86, но не для arm64, пожалуйста, [сообщите о проблеме](../development/issues.md) с "Windows on Arm" в заголовке.
