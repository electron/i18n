---
title: 'إلكترون الداخلي&#58؛ استخدام العقدة كمكتبة'
author: zcbenz
date: '2016-08-08'
---

هذه هي الوظيفة الثانية في سلسلة مستمرة تشرح الداخليين لـ إلكترون. تحقق من [أول مشاركة](https://electronjs.org/blog/2016/07/28/electron-internals-node-integration) حول تكامل الحلقة إذا لم تكن قد فعلت ذلك من قبل.

معظم الناس يستخدمون [العقدة](https://nodejs.org) للتطبيقات على جانب الخادم، ولكن بسبب ثراء Node's API الذي تم إعداده وازدهاره ، فإنه أيضا يصلح للمكتبة المدمجة. يوضح هذا المنشور كيفية استخدام العقدة كمكتبة في إلكترون.

---

## بناء النظام

كل من العقدة والإلكترون يستخدم [`GYP`](https://gyp.gsrc.io) كأنظمة بناء لديهما. إذا كنت ترغب في تضمين عقدة داخل التطبيق الخاص بك، يجب عليك استخدامه كنظام بناء خاص بك أيضا.

جديد في `GYP`? اقرأ [هذا الدليل](https://gyp.gsrc.io/docs/UserDocumentation.md) قبل أن تستمر في هذا المنشور.

## أعلام العقدة

عقدة [`yp`](https://github.com/nodejs/node/blob/v6.3.1/node.gyp) ملف في دليل الكود المصدري للعقدة يصف كيفية بناء العقدة ، بالإضافة إلى الكثير من [`GYP`](https://gyp.gsrc.io) متغيرات تتحكم في أجزاء العقدة التي يتم تمكينها وما إذا كان سيتم فتح بعض الإعدادات.

لتغيير أعلام البناء، تحتاج إلى تعيين المتغيرات في ملف `.gypi` من مشروعك. البرنامج النصي `تهيئة` في العقدة يمكن أن ينشئ بعض الإعدادات الشائعة لك، على سبيل المثال تشغيل `. تكوين --شارك` سيولد `config.gypi` مع المتغيرات التي توجه عقدة لكي يتم بناؤها كمكتبة مشتركة.

إلكترون لا يستخدم البرنامج النصي `configure` لأن لديه نصوصه الخاصة للبناء. تم تعريف تكوينات العقدة في ملف [`الشائع.gypi`](https://github.com/electron/electron/blob/master/common.gypi) في دليل رمز المصدر الرئيسي لـ Electrons.

## ربط العقدة مع إلكترون

في إلكترون، يتم ربط العقدة كمكتبة مشتركة عن طريق تعيين متغير `GYP` `عقدة مشتركة` إلى `صحيح`، لذلك سيتم تغيير نوع بناء العقدة من `قابل للتنفيذ` إلى `مشاركة المكتبة`، ولن يتم تجميع رمز المصدر الذي يحتوي على العقدة `الرئيسية` نقطة الدخول.

بما أن إلكترون يستخدم مكتبة V8 المشحونة مع Chromium، فإن مكتبة V8 المتضمنة في رمز مصدر Node's غير مستخدمة. يتم ذلك عن طريق إعداد كل من `node_use_v8_platform` و `node_use_bundled_v8` إلى `false`.

## المكتبة المشتركة أو المكتبة الثابتة

عند الربط مع العقدة، هناك خياران: يمكنك بناء العقدة كمكتبة ثابتة وإدراجها في قابلة للتنفيذ النهائي. أو يمكنك بناءه كمكتبة مشتركة وشحنه جنبا إلى جنب مع التنفيذ النهائي.

في إلكترون، تم بناء العقدة كمكتبة ثابتة لفترة طويلة. هذا جعل بناء بسيط، ومكّن أفضل تحسينات المترجم، ومكّن إلكترون من أن يتم توزيعه بدون ملف `عقد.dll` إضافي.

ومع ذلك، تغير هذا بعد أن تحول كروم إلى استخدام [BoringSSL](https://boringssl.googlesource.com/boringssl). BoringSSL هو شوك من [OpenSSL](https://www.openssl.org) الذي يزيل العديد من واجهات APIs غير مستخدمة ويغير العديد من الواجهات الموجودة نظرًا لأن العقدة لا تزال تستخدم OpenSSL، سيقوم المترجم بإنشاء العديد من الأخطاء في الربط بسبب تضارب الرموز إذا تم ربطها معا.

إلكترون لا يمكن استخدام BoringSSL في العقدة، أو استخدام OpenSSL في Chromium، لذلك كان الخيار الوحيد هو التبديل إلى بناء العقدة كمكتبة مشتركة، و [إخفاء رموز BoringSSL و OpenSSL](https://github.com/electron/electron/blob/v1.3.2/common.gypi#L209-L218) في مكونات كل منها.

هذا التغيير جلب اليكترون بعض الآثار الجانبية الإيجابية. قبل تغيير هذا لم تتمكن من إعادة تسمية الملف القابل للتنفيذ من إلكترون على ويندوز إذا استخدمت وحدات أصلية لأن اسم الجهاز التنفيذي تم ترميزه في مكتبة الاستيراد. بعد بناء العقدة كمكتبة مشتركة، تم تحديد هذا الحد لأن جميع الوحدات الأصلية كانت مرتبطة بالعقدة `. ل`، الذي لم يكن اسمه بحاجة إلى أن يتغير.

## دعم الوحدات الأصلية

[وحدات نمطية أصلية](https://nodejs.org/api/addons.html) في عمل العقدة من خلال تحديد دالة إدخال العقدة لتحميلها، ثم البحث عن رموز V8 والشيبوف من العقدة. هذه مشكلة قليلاً في المدمجين لأن رموز V8 و libuv بشكل افتراضي هي مخفية عند بناء العقدة كمكتبة والوحدات الأصلية سوف تفشل في تحميل لأنهم لا يستطيعون العثور على الرموز.

لذا من أجل جعل الوحدات المحلية تعمل ، تم الكشف عن رموز V8 و libuv في إلكترون. بالنسبة ل V8 يتم هذا عن طريق [إجبار جميع رموز في ملف تكوين Chromium على الكشف عن](https://github.com/electron/libchromiumcontent/blob/v51.0.2704.61/chromiumcontent/chromiumcontent.gypi#L104-L122). For libuv, it is achieved by [setting the `BUILDING_UV_SHARED=1` definition](https://github.com/electron/electron/blob/v1.3.2/common.gypi#L219-L228).

## بدء عقدة في التطبيق الخاص بك

بعد كل أعمال البناء والربط مع العقدة، الخطوة الأخيرة هي تشغيل عقدة في التطبيق الخاص بك.

العقدة لا توفر العديد من واجهات برمجة التطبيقات العامة لتضمينها في تطبيقات أخرى. عادة، يمكنك فقط الاتصال بـ [`عقدة:Start` و `العقدة:Init`](https://github.com/nodejs/node/blob/v6.3.1/src/node.h#L187-L191) لبدء مثيل جديد من العقدة. ومع ذلك، إذا كنت تبني تطبيقا معقدا استنادا إلى العقدة، عليك استخدام APIs مثل `عقدة::CreateEnvironment` للتحكم بدقة في كل خطوة

في إلكترون ، تبدأ العقدة في وضعين : الوضع المستقل الذي يعمل في العملية الرئيسية ، والذي يشبه ثنائيات العقدة الرسمية، والوضع المدمج الذي يدرج واجهة برمجة تطبيقات العقدة في صفحات الويب. سيتم شرح تفاصيل هذا في وظيفة مقبلة.

