---
title: 'Інтерналі: Будівництво Chromium в якості бібліотеки'
author: zcbenz
date: '2017-03-03'
---

Electron засновано на Google open-source Chromium, проекті, який не обов'язково розроблений для використання іншими проектами. Цей пост представляє як бібліотеку Chromium побудовано як бібліотеку для використання Electron, і як розроблена система будівництва протягом багатьох років.

---

## Використання CEF

The Chromium Embedwork (CEF) - це проект, який перетворює Chromium на бібліотеку і забезпечує стабільні API-інтерфейси на основі коду Chromium. Лише ранні версії Atom editor and NW.js використовували CEF.

Для підтримки стабільного API, CEF приховує всі деталі Chromium і огортає API Chromium зі своїм власним інтерфейсом. Тому коли нам потрібен доступ до основних API Chromium, наприклад, інтеграція Node.js на веб-сторінки, переваги CEF стали блокувальниками.

Отож, у кінці Electron та NW.js перемикались на використання API Chromium безпосередньо.

## Будівля як частина Хрому

Незважаючи на те, що Chromium офіційно не підтримує зовнішні проекти, код є модульним, і легко створити мінімальний браузер на основі Chromium. Ядро , що надає інтерфейс браузера називається Модуль контенту.

Для розробки проекту з модулем Контенту, найпростішим способом створити проект як частину Chromium. Це можна зробити шляхом першої перевірки коду Chromium , а потім додавання проекту в `DEPS` файлу.

NW.js та дуже ранні версії Electron використовують цей спосіб для побудування.

Зворотній бік означає, що Chromium - це дуже велика кодова база і потребує дуже потужних машин для побудування. Для нормальних ноутбуків, які можуть зайняти більше 5 годин. Це значно вплине на кількість розробників, які можуть зробити внесок в проект, а також пришвидшити розробку.

## Побудова хрому як єдину спільну бібліотеку

Як користувач вмісту модуля, Electron не потребує редагування коду Chromium під більшими випадками, таким чином, очевидний спосіб поліпшити побудову Electron - побудувати Chromium як спільну бібліотеку, а потім посилатися з ним через Electron. У цьому розробникам більше не потрібно створювати усі вимкнені Chromium при включенні Electron.

Проект [libchromiumcontent](https://github.com/electron/libchromiumcontent) створено [@aroben](https://github.com/aroben) для цієї мети. Він будує модуль Контенту Chromium як спільна бібліотека, а потім забезпечує заголовки Chromium та попередньо побудовані бінарні файли для завантаження. Код початкової версії libchromiumcontent знайдено [у цьому посиланні](https://github.com/electron/libchromiumcontent/tree/873daa8c57efa053d48aa378ac296b0a1206822c).

Проект [яскравим треєм](https://github.com/electron/brightray) також народився як частина вмісту libchromiumcontent, який забезпечує тонкий шар навколо модуля контенту.

Використовуючи libchromiumcontent і яскравіше разом розробники можуть швидко будувати браузер без деталей побудови Chromium. І це знімає вимоги швидкої мережі і потужного автомату для будівлі проекту.

Apart from Electron, there were also other Chromium-based projects built in this way, like the [Breach browser](https://www.quora.com/Is-Breach-Browser-still-in-development).

## Фільтрування експортованих символів

На Windows є обмеження кількості символів з однієї спільної бібліотеки експорту. В якості кодової бази Chromium кількість символів, що експортуються в libchromiumcontent незабаром перевищила обмеження.

Рішення було відфільтрувати непотрібні символи під час генерації DLL-файлу. Це спрацювало [, підставляючи `. ef файл` на linker](https://github.com/electron/libchromiumcontent/pull/11/commits/85ca0f60208eef2c5013a29bb4cf3d21feb5030b), а потім використовуючи скрипт до [судити про те, чи мають бути символи в просторі імен , що експортується](https://github.com/electron/libchromiumcontent/pull/47/commits/d2fed090e47392254f2981a56fe4208938e538cd).

Використовуючи цей підхід, Chromium продовжував додавати нові експортовані символи, libchromiumcontent все ще може створювати загальні файли бібліотеки, знищуючи більше символів.

## Збірка компонентів

Перед тим, як говорити про наступні кроки, зроблені в libchromicontt, важливо додати концепцію побудови компонентів в Chromium.

Як величезний проект, крок зв'язування займає дуже багато часу в Chromium при будуванні. Як правило, коли розробник трохи змінить, через це може зайняти 10 хвилин, щоб побачити остаточний результат . Для цього Chromium ввів збірку компонентів, яка будує кожен модуль в Chromium як розділені спільні бібліотеки, тож час, витрачений на остаточне посилання стає непомітним.

## Сирі двійки доставки

З Chromium продовжує рости, в Chromium було так багато експортованих символів, що навіть символи модуля Контенту і Webkit були більшими за обмеженнями. Неможливо створити придатну для використання бібліотеку лише позбавити символи.

Зрештою, ми змушені були [відправити необроблені бінарні файли Chromium](https://github.com/electron/libchromiumcontent/pull/98) замість генерації єдиної спільної бібліотеки.

Як ви вже представили два режими будування в Chromium. В результаті постачати сирі бінарники, ми маємо доставити два різних розподіли виконуваних файлів в libchromiumcontent. Одна називається збірка `static_library` , яка включає в себе всі статичні бібліотеки кожного модуля, згенерованого звичайною збіркою Chromium. Інша - `shared_library`, яка включає в себе всі загальні бібліотеки кожного модуля, згенерованого компонентом.

Для Electron, версія Debug має посилання `shared_library` версії libchromiumcontent, тому що завантаження мале і займає мало часу під час зв'язку з виконуваним файлом. Реліз версії Electron з'єднана з `static_library` версією libchromiumcontent, таким чином, компілятор може генерувати повноцінні символи, які важливі для налагодження, і велінкер може зробити набагато кращу оптимізацію, так як він знає, які файли об'єктів потрібні і які ні.

So for normal development, developers only need to build the Debug version, which does not require a good network or powerful machine. Хоча Реліз версія і потребує значно кращого обладнання для побудови, вона може генерувати краще оптимізовані двійкові системи.

## `вирівняти` оновлення

Being one of the largest projects in the world, most normal systems are not suitable for building Chromium, and the Chromium team develops their own build tools.

Попередні версії Chromium використовували `gyp` як будівельну систему, але вона страждає від повільності, і його конфігураційний файл стає важко зрозуміти для складних проектів. Після багатьох років розробки Chromium перемкнувся на `gn` з будівельною системою , яка набагато швидше має чітку архітектуру.

Одне з покращень `gn` означає ввести `source_set`, який представляє групу об'єктних файлів. In `gyp`, each module was represented by either `static_library` or `shared_library`, and for the normal build of Chromium, each module generated a static library and they were linked together in the final executable. Використовуючи `gn`, кожен модуль генерує тільки купу файлів з об'єктів, і останній виконуваний файл просто зв'язаний усі файли об’єктів разом, , тому файли статичної бібліотеки більше не генеруються.

Однак це вдосконалення викликало великі проблеми з появою libchromiumcontt, так як файли тимчасових статичних бібліотек були насправді потрібні libchromiumcontent.

Перша спроба вирішити цю проблему була [патч `вирівняти` щоб генерувати статичну бібліотеку файли](https://github.com/electron/libchromiumcontent/pull/239)який вирішив проблему, але був далеко не гідним рішенням.

Друга спроба була зроблена [@alespergl](https://github.com/alespergl) до [виробляє спеціальні статичні бібліотеки з списку об'єктів](https://github.com/electron/libchromiumcontent/pull/249). За допомогою трюка вперше запустила туманну білку для збору списку згенерованих файлів об'єкта, а потім - створити статичні бібліотеки, годуючи `gn` зі списком. Він вносив лише мінімальні зміни до джерела Chromium код, і утримував будівельну архітектуру Electron.

## Summary

Як ви можете бачити, в порівнянні з побудовою Electron як частини Chromium, побудова Chromium в якості бібліотеки, займає більше зусиль і вимагає безперервного обслуговування. Однак останнє знімає вимоги потужного обладнання , щоб створити Electron, Таким чином, забезпечення набагато більшого діапазону розробників для створення і сприяння Electron. Зусилля варті того.

